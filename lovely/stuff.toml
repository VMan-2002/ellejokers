[manifest]
version = "0.1.0"
dump_lua = true
priority = 0

# Add Spearlamp info_queue messages to steel & slime cards
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = 'for _, v in ipairs(info_queue) do'
position = "before"
payload = '''
-- ellejokers. stuff :p
if (card) then
	-- Spearlamp support
	if (#SMODS.find_card("j_elle_spearlamp", false)>0) then
		if (_c.key == "m_steel") then info_queue[#info_queue+1] = G.P_CENTERS.m_elle_slime end
		if (_c.key == "m_elle_slime") then info_queue[#info_queue+1] = G.P_CENTERS.m_steel end
	end
end
'''
match_indent = true

# Fix Card:load()
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''self.VT.h = self.T.H'''
position = "at"
payload = '''self.VT.h = self.T.h'''
match_indent = true

# Skip Shop on Caf√© Frequent Challenge
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.STATE = G.STATES.SHOP'''
position = "after"
payload = '''if (G.GAME.modifiers.elle_no_shop) then G.STATE = G.STATES.BLIND_SELECT end'''
match_indent = true

# Rebecca booster stuff, copy-pasted from JoyousSpring
# https://github.com/nh6574/JoyousSpring/blob/48423d78db5e2a6f16a471d1211d2457b370d413/lovely/states.toml#L80

# Prevent booster in booster softlock
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''if card.ability.set == 'Booster' then G.GAME.PACK_INTERRUPT = G.STATE end '''
position = "at"
payload = '''
if G.STATE ~= G.STATES.SMODS_BOOSTER_OPENED then
    if card.ability.set == 'Booster' then G.GAME.PACK_INTERRUPT = G.STATE end
end
'''
match_indent = true

# Open booster in a round (not used yet but it's nice so I'm keeping it just in case)
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = '''G.FUNCS.draw_from_hand_to_deck()'''
position = "at"
payload = '''
if G.GAME.PACK_INTERRUPT ~= G.STATES.SELECTING_HAND then
    G.FUNCS.draw_from_hand_to_deck()
end
'''
match_indent = true